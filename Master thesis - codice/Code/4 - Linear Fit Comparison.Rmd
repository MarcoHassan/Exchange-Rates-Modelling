---
title: "Linear Fit Comparison"
output: rmarkdown::github_document
---

Useful Libraries and Functions
```{r}
## String manipulation library using regualr expressions

library(stringr) ## to make use of regular expressions to parse strings

## VAR packages

library(vars)  ## to estimate VAR lag with exogenous variables
library(tsDyn) ## to estimate the VAR model and perform the out of sample fit based on rolling window.

## Import self defined functions
source("0 - functions.R") ## for this section especially important is the SPA function that returns the bootstrapped interval for the superior preddiction ability hypothesis.
```


===========
Import Data
===========
```{r}

```


======================================================
Out of sample performance comparison for linear models
======================================================

In this section I will compare the performance of the different linear models in the out of sample predicition fit.

Plot the different out of sample forecasting fits
```{r}
plot(tail(data$EX_CHUS, 50), ylab="Rates", main="Linear Estimators - 1 Lag Out of Sample", 
     grid.col = NA, col = 1)
lines(data$rwPred1_CHUS,col= 2, lwd = 2)
lines(data$strPred1_CHUS, col = "orange", lwd = 2)
lines(data$varPred1_CHUS, col = "yellow", lwd = 2)
addLegend("topleft", on=1, 
          legend.names = c("Original", "RW", "ARIMAX", "VAR"), 
          lty=c(1, 1), lwd=c(2, 1),
          col=c(1, 2, "orange", "yellow"))
```


* Step 2 - Quantitative Measure for Prediction Power

Root Mean Squared Error (MSE)
```{r}
rmseFun <- 
          function(error)
          {
            #error <- Actual - Forecast
            #print(error)
            return( sqrt(sum(error**2)/length(error)) )
          }
```

Mean Absolute Error (MAE)
```{r}
maeFun <- 
            function(error)
            {
              #return( Actual - Forecast )
              return( sum(abs(error))/length(error) )
            }
```

Directional Accuracy (DAC)
```{r}
dacFun <- 
          function(Actual, Forecast, LAG)
          {
            return( mean ( sign( diff(Actual, lag=LAG) ) == 
                           sign( diff(Forecast, lag=LAG) ),
                           na.rm = T
                          ) 
                  )
          }
```


Create Series of Forcasting Errors; repeat for all of the lags.
```{r}

# number rolling prediction per forecasting time frame
for(iLag in c(1,3,6,12))
{
assign(paste0("numprediction", iLag), sum(
                                          !is.na(
                                                  data[, 
                                                      paste0("rwPred", iLag, "_JPUS")
                                                      ]
                                                 )
                                          )
       )
  
}

RMSE <- matrix(NA,3,3, 
               dimnames = list( c("rw", "str", "var"),
               c("CH", "JP", "UK") )
               )

MAE <- matrix(NA,3,3, 
               dimnames = list( c("rw", "str", "var"),
               c("CH", "JP", "UK") )
               )

DAC <- matrix(NA,3,3, 
               dimnames = list( c("rw", "str", "var"),
               c("CH", "JP", "UK") )
               )
```


Compute root mean square error and mean absolute error for the different lags and linear estimators
```{r}
errorFun <- 
            function(LAG)
            {
              iRow = 0
              jCol = 1
              for( country in c("CH", "JP", "UK") )
              {
                for( method in c("rw", "str", "var") )
                {
                  iRow = iRow + 1
                  
                  actual_data <- tail(data[, paste0("EX_", country, "US")],
                                      evalue(paste0("numprediction", LAG))
                                      )
                  
                  forecast_data <- na.trim(data[, paste0(method, 
                                                "Pred", LAG,"_", 
                                                country, "US")
                                               ]
                                           )
                  
                  error_data <- actual_data - forecast_data
                  
                  RMSE[iRow, jCol] <- rmseFun(error_data)
                  
                  MAE[iRow, jCol] <- maeFun(error_data)
                  
                  DAC[iRow, jCol] <- dacFun(actual_data, forecast_data, LAG)
                  
                  if(iRow %% 3 == 0)
                  {
                    jCol = jCol + 1
                    iRow = 0
                  }
                
                }
              }
              
              print(paste("RMSE", LAG))
              print(RMSE)
              
              print(paste("MAE", LAG))    
              print(MAE)
              
              print(paste("DAC", LAG))    
              print(DAC)
            }
```

Evalue the function for different lags
```{r}
for( iLAG in c(1, 3, 6, 12))
errorFun(iLAG)
```

============
Augmented MZ 
============

Test if the model can be restricted; i.e. test the null hypothesis of the different coefficients.

!!!! USE AUGMENTED MZ TESTS TO CHECK WHETHER MORE SIMPLE MODELS HOLD IN THE DATA.

====================
Model Confidence set
====================

Model Confidence set
```{r}
#Create u a matrix with all different univariate GARCH predictions: each column, one model prediction
u <- na.trim(cbind(data$rwPred1_JPUS, data$varPred1_JPUS, data$strPred1_JPUS))

n<-dim(u)[1]
perf<-matrix(NA,n,3)

for (j in 1:3)
{
  perf[,j]<- abs(tail(data$EX_JPUS[-nrow(data)], n)-u[,j]) #MAE
  #perf[,j] <- abs(data$EX_JPUS-u[,j])^2 #MSE
}

colMeans(perf) ## Perf is a matrix containing for each column the loss function of one forecasting method.
  
for (k in 1:3)
{
  print(k)	
  d<-rep(0,1000)
  s<-1
  for (i in 1:10)
  { 
  	#print(i)
     e<-spa(per=perf,column_benchmark_model=k,
            num_predmodels=3,number_predictions=n,q=0.25,iter=100,periodogram=T)
     d[s:(s+99)]<-e$stat.boos
     s<-s+100
  }
  print(mean((d>e$stat))) ## fraction 
}

## With MSE
## -> random walk excluded wit 90% confidence

## With MAE
## -> random walk excluded with 99% confidence
## -> arimax with 

```
